<!DOCTYPE html>
<html>
<head>
  <title>svg2lines</title>
  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      height: 100%;
    }

    .in {
      box-shadow: inset 0 0 30px #8BC34A;
    }
  </style>
</head>
<body>

<div id="holder"></div>
<script>
  var body = document.getElementsByTagName('body')[0];

  window.addEventListener("dragover", function (e) {
    e = e || event;
    e.preventDefault();
  }, false);

  window.addEventListener("drop", function (e) {
    e = e || event;
    e.preventDefault();
  }, false);

  body.addEventListener('dragenter', function (e) {
    e.preventDefault();
    console.log('entering');
    body.classList.add('in');
    return false;
  });

  body.addEventListener('dragleave', function (e) {
    e.preventDefault();
    console.log('leaving');
    body.classList.remove('in');
    return false;
  });

  body.addEventListener('drop', function (e) {
    body.classList.remove('in');
    e.preventDefault();

    var file = e.dataTransfer.files[0];
    var reader = new FileReader();
    reader.onload = function (event) {
      var text = event.target.result;
      var parser = new DOMParser();
      var doc = parser.parseFromString(text, "image/svg+xml");
      try {
        svg2lines(doc.children[0]);
      } catch (e) {
        alert(e.message);
      }
    };
    reader.readAsText(file);

    return false;
  });


  window.converters = {

    line: function (attributes) {
      return [
        [
          parseFloat(attributes.x1.value),
          parseFloat(attributes.y1.value),
          parseFloat(attributes.x2.value),
          parseFloat(attributes.y2.value)
        ]
      ];
    },

    rect: function (attributes) {
      var x = parseFloat(attributes.x.value), y = parseFloat(attributes.y.value);
      var w = parseFloat(attributes.width.value), h = parseFloat(attributes.height.value);

      return [
        [x, y, x + w, y],
        [x + w, y, x + w, y + h],
        [x + w, y + h, x, y + h],
        [x, y + h, x, y]
      ];
    }
  };


  window.svg2lines = function (svg) {
    if (svg.tagName !== 'svg') {
      throw new Error("Formato non supportato. Caricare SVG.")
    }

    var lines = [];
    for (var i = 0; i < svg.childNodes.length; i++) {
      var node = svg.childNodes[i];
      if (node.nodeType !== Node.ELEMENT_NODE) continue;
      var type = node.tagName;

      if (!window.converters[type]) {
        throw new Error("Spiacente ma al momento i nodi di '" + type + "' non sono supportati");
      } else {
        window.converters[type](node.attributes, node).forEach(function (line) {
          lines.push(line);
        })
      }
    }

    console.log('lines', lines);

  };


</script>

</body>
</html>
