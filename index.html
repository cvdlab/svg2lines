<!DOCTYPE html>
<html>
<head>
  <title>svg2lines</title>
  <style>
    html, body {
      margin: 0 !important;
      padding: 0 !important;
      height: 100%;
    }

    .in {
      box-shadow: inset 0 0 30px #8BC34A;
    }

    #btn-download {
      position: fixed;
      top: -9999999px;
    }

  </style>
</head>
<body>
<a href="#" id="btn-download">Download</a>
<div id="holder"></div>
<script>
  var body = document.getElementsByTagName('body')[0];
  var link = document.getElementById('btn-download');

  window.addEventListener("dragover", function (e) {
    e = e || event;
    e.preventDefault();
  }, false);

  window.addEventListener("drop", function (e) {
    e = e || event;
    e.preventDefault();
  }, false);

  body.addEventListener('dragenter', function (e) {
    e.preventDefault();
    console.log('entering');
    body.classList.add('in');
    return false;
  });

  body.addEventListener('dragleave', function (e) {
    e.preventDefault();
    console.log('leaving');
    body.classList.remove('in');
    return false;
  });

  function eventFire(el, etype) {
    if (el.fireEvent) {
      el.fireEvent('on' + etype);
    } else {
      var evObj = document.createEvent('Events');
      evObj.initEvent(etype, true, false);
      el.dispatchEvent(evObj);
    }
  }

  body.addEventListener('drop', function (e) {

    body.classList.remove('in');
    e.preventDefault();

    var file = e.dataTransfer.files[0];
    var reader = new FileReader();
    reader.onload = function (event) {
      var text = event.target.result;
      var parser = new DOMParser();
      var doc = parser.parseFromString(text, "image/svg+xml");
      try {
        var output = svg2lines(doc.children[0]);
        var data = new Blob([output], {type: 'text/plain'});
        var url = window.URL.createObjectURL(data);
        link.setAttribute('download', "output.lines");
        link.href = url;

        eventFire(link, 'click');
      } catch (e) {
        alert(e.message);
        console.error(e);
      }
    };
    reader.readAsText(file);

    return false;
  });


  window.converters = {

    svg: function (attributes, node) {
      var lines = [];

      for (var i = 0; i < node.childNodes.length; i++) {

        var children = node.childNodes[i];
        if (children.nodeType !== Node.ELEMENT_NODE) continue;

        var type = children.tagName;

        if (!window.converters[type]) {
          throw new Error("Spiacente ma al momento i nodi di '" + type + "' non sono supportati");
        } else {
          window.converters[type](children.attributes, children).forEach(function (line) {
            lines.push(line);
          })
        }
      }
      return lines;
    },

    g: function (attributes, node) {
      return window.converters.svg(attributes, node);
    },

    line: function (attributes) {
      return [
        [
          parseFloat(attributes.x1.value),
          parseFloat(attributes.y1.value),
          parseFloat(attributes.x2.value),
          parseFloat(attributes.y2.value)
        ]
      ];
    },


    rect: function (attributes) {
      var x = parseFloat(attributes.x.value), y = parseFloat(attributes.y.value);
      var w = parseFloat(attributes.width.value), h = parseFloat(attributes.height.value);

      return [
        [x, y, x + w, y],
        [x + w, y, x + w, y + h],
        [x + w, y + h, x, y + h],
        [x, y + h, x, y]
      ];
    },


    polyline: function (attributes) {
      var pairSplitter = function (pair) {
        return pair.split(',').map(parseFloat);
      };
      var points = attributes.points.value.split(' ').map(pairSplitter);

      var lines = [];
      for (var i = 0; i < points.length - 1; i++) {
        lines.push([points[i][0], points[i][1], points[i + 1][0], points[i + 1][1]]);
      }
      return lines;
    },


    polygon: function (attributes) {
      var polylineConverter = window.converters.polyline;

      var lines = polylineConverter(attributes);
      var first = lines[0];
      var last = lines[lines.length - 1];
      lines.push([last[0], last[1], first[0], first[1]]);

      return lines;
    },


    circle: function (attributes) {
      var cx = parseFloat(attributes.cx.value);
      var cy = parseFloat(attributes.cy.value);
      var r = parseFloat(attributes.r.value);

      var linesCount = 20;
      var deltaAlfa = 2 * Math.PI / linesCount;

      var points = [];

      for (var j = 0; j < linesCount; j++) {
        var alfa = j * deltaAlfa;
        var x = r * Math.cos(alfa) + cx;
        var y = r * Math.cos(alfa) + cy;

        points.push([x, y]);
      }

      var lines = [];
      for (var i = 0; i < points.length - 1; i++) {
        lines.push([points[i][0], points[i][1], points[i + 1][0], points[i + 1][1]]);
      }
      return lines;
    }
  };


  window.svg2lines = function (svg) {
    if (svg.tagName !== 'svg') {
      throw new Error("Formato non supportato. Caricare SVG.")
    }
    var lines = window.converters['svg'](svg.attributes, svg);

    console.log('lines', lines);

    var output = lines.map(function (row) {
      return row.join(',');
    }).join('\n');

    return output;
  };


</script>

</body>
</html>
